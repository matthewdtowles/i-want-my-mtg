import { MigrationInterface, QueryRunner } from 'typeorm';

export class CreatePricePartitionTable1627896543210 implements MigrationInterface {
  public async up(queryRunner: QueryRunner): Promise<void> {
    // Create main Price table
    await queryRunner.query(`
      CREATE TABLE Price (
        id SERIAL PRIMARY KEY,
        normalPrice DECIMAL,
        foilPrice DECIMAL,
        date DATE,
        cardId INT,
        FOREIGN KEY (cardId) REFERENCES Card(id)
      ) PARTITION BY RANGE (date);
    `);

    // Create partitions for each month
    await queryRunner.query(`
      CREATE TABLE Price_2023_01 PARTITION OF Price
        FOR VALUES FROM ('2023-01-01') TO ('2023-02-01');
    `);
    await queryRunner.query(`
      CREATE TABLE Price_2023_02 PARTITION OF Price
        FOR VALUES FROM ('2023-02-01') TO ('2023-03-01');
    `);
  }

  public async down(queryRunner: QueryRunner): Promise<void> {
    // Drop the partitions and the main table
    await queryRunner.query('DROP TABLE IF EXISTS Price_2023_01');
    await queryRunner.query('DROP TABLE IF EXISTS Price_2023_02');
    await queryRunner.query('DROP TABLE IF EXISTS Price');
  }
}
